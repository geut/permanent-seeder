#!/usr/bin/env node

const { SDK } = require('@geut/permanent-seeder-sdk')

const { MESSAGE_KEY_ADD } = require('./constants')

let sdk

const seederDaemon = async () => {
  const config = JSON.parse(process.argv[2])
  const hot = Boolean(process.argv[3])

  sdk = new SDK(config)

  await sdk.start('seeder', hot)
}

const messageHandlers = {
  [MESSAGE_KEY_ADD]: handleAddKeyMessage
}

async function handleAddKeyMessage (packet) {
  await sdk.addKey(packet.data)
}

async function handleMessage (packet) {
  if (!messageHandlers[packet.topic]) return

  await messageHandlers[packet.topic](packet)
}

process.on('message', handleMessage)

process.on('exit', function () {
  process.off('message', handleMessage)
})

seederDaemon().catch(error => {
  console.error(error)
  process.exit(1)
})
